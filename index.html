<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>COC7 æˆ˜æ–—æ§åˆ¶å° v3.2 (Mobile Fix + Step Dice)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* =====================================================
           RATIONAL GRID & ARCHIVE - ç†æ€§å‡ ä½•è®¾è®¡ç³»ç»Ÿ
           çº¿æ¡†åŒ– / å…¨å¤§å†™æ ‡ç­¾ / çº¯é»‘è¾¹æ¡† / æ— èƒŒæ™¯è‰²
           ===================================================== */
        :root {
            --color-player: #2563eb;
            --color-enemy: #dc2626;
            --color-border: #000;
            --color-border-light: #d1d5db;
            --faction-strip-width: 4px;
        }

        * { 
            box-sizing: border-box; 
            border-radius: 0 !important;
        }
        
        html, body { 
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            margin: 0; 
            padding: 0;
            overflow: hidden; 
            position: fixed;
            overscroll-behavior: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        #root {
            height: 100%;
            width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .main-layout {
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header { flex: 0 0 56px; }

        main {
            flex: 1;
            overflow: hidden;
            position: relative;
            height: calc(100% - 56px);
            display: flex;
            flex-direction: column;
            min-height: 0; 
        }

        /* ä¸‰æ å¸ƒå±€ */
        .combat-grid {
            display: grid;
            grid-template-columns: 280px 1fr 300px;
            height: 100%;
            overflow: hidden;
        }

        .panel-scroll {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .panel-left {
            background-color: #fff;
            border-right: 1px solid var(--color-border);
        }

        .panel-right {
            background-color: #fff;
            border-left: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }
        
        .log-scroll-area {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            -webkit-overflow-scrolling: touch;
        }

        .panel-center {
            position: relative;
            background-color: #f8f8f8;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .action-area {
            flex: 1;
            position: relative;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
        }

        .centered-card {
            width: 90%;
            max-width: 440px;
            max-height: 90%;
            overflow-y: auto;
            background: #fff;
            border: 2px solid var(--color-border);
            z-index: 10;
            margin: auto;
        }

        /* è®¾ç½®é¡µé¢ */
        .setup-grid {
            display: flex;
            height: 100%;
            overflow: hidden;
            flex-direction: row; 
        }

        .setup-sidebar {
            width: 280px;
            background-color: #fff;
            flex-shrink: 0;
            height: 100%;
            overflow-y: auto;
            border-right: 1px solid var(--color-border);
        }

        .setup-content {
            flex: 1;
            background-color: #fff;
            height: 100%;
            overflow-y: auto;
            min-height: 0;
        }

        /* KPé¢æ¿ */
        .kp-panel {
            position: fixed;
            top: 56px;
            right: 0;
            bottom: 0;
            width: 350px;
            background: #fff;
            border-left: 3px solid var(--color-enemy);
            z-index: 100;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }
        .kp-panel.open { transform: translateX(0); }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #000; }

        /* =====================================================
           è§’è‰²å¡ç‰‡ - é˜µè¥è‰²æ¡ + é€‰ä¸­çŠ¶æ€
           ===================================================== */
        .char-card {
            background: #fff;
            color: #000;
            border: 1px solid var(--color-border);
            transition: all 0.15s ease;
            cursor: pointer;
            position: relative;
        }
        
        .faction-strip-player { border-left: var(--faction-strip-width) solid var(--color-player) !important; }
        .faction-strip-enemy { border-left: var(--faction-strip-width) solid var(--color-enemy) !important; }
        
        /* é€‰ä¸­çŠ¶æ€ - çº¯é»‘åè‰² */
        .char-card.selected {
            background: #000 !important;
            color: #fff !important;
            border: 2px solid #000;
        }
        
        /* ç›®æ ‡é€‰ä¸­ - æ›´æ˜æ˜¾çš„æŒ‡ç¤ºå™¨ */
        .char-card.target-selected {
            outline: 3px solid #000;
            box-shadow: 0 0 0 6px rgba(0,0,0,0.2);
        }
        .char-card.target-selected::after {
            content: "ğŸ¯";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            opacity: 0.6;
            pointer-events: none;
        }

        /* =====================================================
           è‡ªå®šä¹‰æ•°å­—é”®ç›˜ (CustomNumPad) - çº¯é»‘è®¾è®¡
           ===================================================== */
        .numpad-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        
        .numpad-container {
            background: #000;
            width: 100%;
            max-width: 400px;
            padding: 16px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom, 0));
        }
        
        .numpad-label {
            color: #fff;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .numpad-display {
            font-size: 36px;
            font-family: ui-monospace, monospace;
            text-align: center;
            padding: 16px;
            background: #fff;
            color: #000;
            margin-bottom: 12px;
            min-height: 68px;
            border: 2px solid #fff;
        }
        
        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .numpad-btn {
            height: 60px;
            font-size: 24px;
            font-weight: bold;
            border: 2px solid #fff;
            background: transparent;
            color: #fff;
            cursor: pointer;
            transition: all 0.1s;
            font-family: ui-monospace, monospace;
        }
        .numpad-btn:active { background: #fff; color: #000; }
        .numpad-btn.confirm { background: #fff; color: #000; }
        .numpad-btn.confirm:active { background: #ccc; }

        .numpad-quick {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .numpad-quick button {
            flex: 1;
            padding: 10px;
            font-size: 12px;
            font-weight: bold;
            border: 1px solid #fff;
            background: transparent;
            color: #fff;
            cursor: pointer;
            text-transform: uppercase;
        }
        .numpad-quick button:active { background: #fff; color: #000; }

        /* =====================================================
           SmartInput - ç‚¹å‡»å¼æ•°å€¼è¾“å…¥ï¼ˆä¸è§¦å‘åŸç”Ÿé”®ç›˜ï¼‰
           ===================================================== */
        .smart-input-container {
            display: flex;
            flex-direction: column;
        }
        .smart-input-label {
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #666;
            margin-bottom: 2px;
        }
        .smart-input-value {
            font-family: ui-monospace, monospace;
            font-size: 14px;
            padding: 6px 8px;
            border: 1px solid #000;
            background: #fff;
            cursor: pointer;
            min-height: 32px;
            display: flex;
            align-items: center;
            transition: background 0.1s;
        }
        .smart-input-value:hover { background: #f0f0f0; }
        .smart-input-value:active { background: #e0e0e0; }
        .smart-input-value.readonly {
            background: #f5f5f5;
            color: #888;
            cursor: not-allowed;
            border-style: dashed;
        }

        /* =====================================================
           çŠ¶æ€ç½‘æ ¼
           ===================================================== */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
        }
        .status-btn {
            padding: 8px 4px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            text-align: center;
            border: 1px solid #000;
            background: #fff;
            color: #999;
            cursor: pointer;
        }
        .status-btn.active-danger { background: var(--color-enemy); color: #fff; border-color: var(--color-enemy); }
        .status-btn.active-dark { background: #000; color: #fff; }

        /* =====================================================
           å¥–åŠ±éª°/æƒ©ç½šéª° é€‰æ‹©å™¨
           ===================================================== */
        .dice-modifier-selector {
            display: flex;
            border: 2px solid #000;
            margin-bottom: 12px;
        }
        .dice-modifier-btn {
            flex: 1;
            padding: 10px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            border: none;
            background: #fff;
            cursor: pointer;
            border-right: 1px solid #000;
        }
        .dice-modifier-btn:last-child { border-right: none; }
        .dice-modifier-btn.active { background: #000; color: #fff; }
        .dice-modifier-btn:hover:not(.active) { background: #f0f0f0; }

        /* =====================================================
           åˆ†æ­¥éª¤éª°å­åŠ¨ç”»é¢æ¿
           ===================================================== */
        .step-dice-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .step-dice-container {
            background: #000;
            border: 3px solid #fff;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .step-dice-title {
            color: #fff;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 16px;
        }
        .step-dice-display {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 20px 0;
        }
        .dice-block {
            width: 60px;
            height: 60px;
            background: #fff;
            color: #000;
            font-size: 28px;
            font-family: ui-monospace, monospace;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #fff;
        }
        .dice-block.rolling {
            animation: dice-shake 0.1s infinite;
            background: #333;
            color: #fff;
        }
        .dice-block.tens { background: #f3f4f6; }
        .dice-block.tens.highlight-good { background: #22c55e; color: #fff; }
        .dice-block.tens.highlight-bad { background: #ef4444; color: #fff; }
        .dice-block.extra { 
            border-style: dashed; 
            background: #fef3c7;
        }
        .dice-block.extra.highlight-good { background: #22c55e; color: #fff; border-style: solid; }
        .dice-block.extra.highlight-bad { background: #ef4444; color: #fff; border-style: solid; }
        
        @keyframes dice-shake {
            0%, 100% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
        }
        
        .step-dice-result {
            font-size: 48px;
            font-family: ui-monospace, monospace;
            font-weight: bold;
            color: #fff;
            margin: 16px 0;
            padding: 12px;
            border: 3px solid #fff;
        }
        .step-dice-result.success { background: #22c55e; }
        .step-dice-result.fail { background: #ef4444; }
        
        .step-dice-explanation {
            color: #9ca3af;
            font-size: 11px;
            margin-top: 12px;
            line-height: 1.5;
        }
        .step-dice-btn {
            margin-top: 16px;
            padding: 12px 24px;
            background: #fff;
            color: #000;
            font-weight: bold;
            border: none;
            cursor: pointer;
            font-size: 14px;
            text-transform: uppercase;
        }
        .step-dice-btn:hover { background: #e5e7eb; }
        .step-dice-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* =====================================================
           ç§»åŠ¨ç«¯å¯¼èˆª - é»˜è®¤éšè—
           ===================================================== */
        .mobile-nav {
            display: none;
        }

        /* =====================================================
           ç§»åŠ¨ç«¯é€‚é…
           ===================================================== */
        @media (max-width: 1024px) {
            input, select, textarea { font-size: 16px !important; }

            /* ç«–å± */
            @media (orientation: portrait) {
                .combat-grid {
                    display: flex;
                    flex-direction: column;
                    height: 100%;
                    width: 100%;
                }

                .panel-left, .panel-center, .panel-right {
                    display: none; 
                    width: 100%;
                    height: 100%;
                    border: none;
                }

                .panel-mobile-active {
                    display: flex !important;
                    flex-direction: column;
                }

                .setup-grid {
                    flex-direction: column !important;
                    min-height: 0;
                }

                .setup-sidebar {
                    width: 100% !important;
                    height: auto !important;
                    max-height: 35dvh;
                    border-right: none !important;
                    border-bottom: 2px solid #000;
                    flex: 0 0 auto;
                    overflow-y: auto !important;
                    -webkit-overflow-scrolling: touch;
                }

                .setup-content {
                    width: 100% !important;
                    flex: 1 1 0% !important; 
                    min-height: 0;
                    overflow-y: auto !important;
                    padding: 16px !important;
                    padding-bottom: 100px !important;
                    -webkit-overflow-scrolling: touch;
                }

                /* å…³é”®ï¼šç§»åŠ¨ç«¯å¯¼èˆªæ åªåœ¨ç«–å±æ—¶æ˜¾ç¤º */
                .mobile-nav { 
                    display: flex !important; 
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    height: 56px;
                    background: #fff;
                    border-top: 2px solid #000;
                    z-index: 9000;
                }

                .centered-card {
                    width: 95%;
                    max-height: none;
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    margin-bottom: 60px;
                }
                
                /* action-area éœ€è¦èƒ½æ»šåŠ¨ */
                .action-area {
                    overflow-y: auto !important;
                    -webkit-overflow-scrolling: touch;
                    padding-bottom: 80px !important;
                }
            }

            /* æ¨ªå± - ä¿®å¤æ»šåŠ¨æ­»é” */
            @media (orientation: landscape) {
                body { 
                    overflow: hidden; 
                    position: fixed; 
                    width: 100%; 
                    height: 100%; 
                }
                
                .combat-grid {
                    display: flex !important;
                    flex-direction: row !important;
                    height: 100%;
                    overflow: hidden;
                }

                .panel-left {
                    display: flex !important;
                    flex-direction: column;
                    width: 180px !important;
                    flex-shrink: 0;
                    height: 100% !important;
                    overflow-y: auto !important;
                    -webkit-overflow-scrolling: touch;
                    overscroll-behavior: contain;
                }
                
                .panel-center {
                    display: flex !important;
                    flex: 1 1 0% !important;
                    flex-direction: column;
                    height: 100% !important;
                    overflow: hidden;
                }
                
                .action-area {
                    flex: 1 1 0% !important;
                    overflow-y: auto !important;
                    -webkit-overflow-scrolling: touch;
                    overscroll-behavior: contain;
                }
                
                .panel-right {
                    display: flex !important;
                    flex-direction: column;
                    width: 200px !important;
                    flex-shrink: 0;
                    height: 100% !important;
                    overflow: hidden;
                }
                
                .log-scroll-area {
                    flex: 1 1 0% !important;
                    overflow-y: auto !important;
                    -webkit-overflow-scrolling: touch;
                    overscroll-behavior: contain;
                }

                .mobile-nav { display: none !important; }

                .setup-grid {
                    display: flex !important;
                    flex-direction: row !important;
                    height: 100%;
                    overflow: hidden;
                }

                .setup-sidebar {
                    width: 200px !important;
                    height: 100% !important;
                    max-height: none !important;
                    border-right: 1px solid #000 !important;
                    border-bottom: none !important;
                    overflow-y: auto !important;
                    -webkit-overflow-scrolling: touch;
                    overscroll-behavior: contain;
                    flex-shrink: 0;
                }

                .setup-content {
                    flex: 1 1 0% !important;
                    height: 100% !important;
                    overflow-y: auto !important;
                    -webkit-overflow-scrolling: touch;
                    overscroll-behavior: contain;
                    min-height: 0;
                }
                
                .centered-card { 
                    max-height: 85%; 
                    overflow-y: auto;
                }
            }
            
            .kp-panel { width: 100%; top: 0; }
            .kp-panel.open { padding-top: 56px; }
        }

        /* æ—¥å¿—æ ·å¼ */
        .log-item {
            padding: 8px;
            border: 1px solid #000;
            margin-bottom: 6px;
            font-size: 11px;
            line-height: 1.4;
            font-family: ui-monospace, monospace;
        }
        .log-item.damage { background: #fee2e2; }
        .log-item.success { background: #dcfce7; }
        .log-item.roll { background: #fff; }
        .log-item.system { background: #e0f2fe; }

        /* æ ‡ç­¾ç»Ÿä¸€æ ·å¼ */
        .label {
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #666;
        }

        /* æ“ä½œåŒºå— */
        .action-block {
            border: 2px solid #000;
            padding: 12px;
            margin-bottom: 12px;
            background: #fff;
        }
        .action-block-title {
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #000;
        }
        .action-btn {
            width: 100%;
            padding: 12px;
            font-weight: bold;
            font-size: 13px;
            border: 2px solid #000;
            background: #000;
            color: #fff;
            cursor: pointer;
        }
        .action-btn:hover { background: #333; }
        .action-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .action-btn.secondary {
            background: #fff;
            color: #000;
        }
        .action-btn.secondary:hover { background: #f0f0f0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
const { useState, useEffect, useMemo, useRef } = React;

// =====================================================
// å¸¸é‡å®šä¹‰
// =====================================================
const BASE_CHARACTER = {
    str: 50, con: 50, siz: 60, dex: 50,
    fight: 50, firearms: 20, dodge: 25,
    firstAid: 30, medicine: 5,
    armorValue: 0, hasGunReady: false,
    meleeWeapon: { name: "æ‹³å¤´", damage: "1D3", type: "melee", impale: false },
    rangedWeapon: null,
    weapons: [], 
    customSkills: [], 
    status: { majorWound: false, dying: false, unconscious: false, prone: false, defenseUsedThisRound: false }
};

const MELEE_WEAPONS = [
    { name: "æ‹³å¤´", damage: "1D3", type: "melee", impale: false },
    { name: "å°åˆ€", damage: "1D4", type: "melee", impale: true },
    { name: "åŒ•é¦–", damage: "1D4+2", type: "melee", impale: true },
    { name: "æ£’çƒæ£", damage: "1D8", type: "melee", impale: false },
    { name: "æ–§å¤´", damage: "1D8+2", type: "melee", impale: true },
    { name: "é•¿å‰‘", damage: "1D8+1", type: "melee", impale: true },
    { name: "å¤§åˆ€", damage: "1D8", type: "melee", impale: true },
];

const RANGED_WEAPONS = [
    { name: ".38å·¦è½®", damage: "1D10", type: "ranged", impale: true, range: 15, ammo: 6, maxAmmo: 6, malfunction: 100 },
    { name: ".45è‡ªåŠ¨æ‰‹æª", damage: "1D10+2", type: "ranged", impale: true, range: 15, ammo: 7, maxAmmo: 7, malfunction: 100 },
    { name: "9mmæ‰‹æª", damage: "1D10", type: "ranged", impale: true, range: 15, ammo: 15, maxAmmo: 15, malfunction: 98 },
    { name: "æ­¥æª", damage: "2D6+4", type: "ranged", impale: true, range: 110, ammo: 5, maxAmmo: 5, malfunction: 100 },
    { name: "éœ°å¼¹æª", damage: "4D6", type: "ranged", impale: false, range: 10, ammo: 2, maxAmmo: 2, malfunction: 100 },
    { name: "å†²é”‹æª", damage: "1D10", type: "ranged", impale: true, range: 20, ammo: 30, maxAmmo: 30, malfunction: 96, autoFire: true },
];

const WEAPON_PRESETS = [...MELEE_WEAPONS, ...RANGED_WEAPONS];

// =====================================================
// å·¥å…·å‡½æ•°
// =====================================================
const rollDice = (expr) => {
    const match = expr.match(/(\d+)[dD](\d+)(?:\+(\d+))?(?:\-(\d+))?/);
    if (!match) return { total: parseInt(expr) || 0, rolls: [] };
    const [, numStr, sidesStr, plusStr, minusStr] = match;
    const num = parseInt(numStr), sides = parseInt(sidesStr);
    const plus = parseInt(plusStr) || 0, minus = parseInt(minusStr) || 0;
    const rolls = Array(num).fill().map(() => Math.floor(Math.random() * sides) + 1);
    return { total: rolls.reduce((s, r) => s + r, 0) + plus - minus, rolls };
};

const getMaxDamage = (expr) => {
    const match = expr.match(/(\d+)[dD](\d+)(?:\+(\d+))?(?:\-(\d+))?/);
    if (!match) return parseInt(expr) || 0;
    const [, numStr, sidesStr, plusStr, minusStr] = match;
    return parseInt(numStr) * parseInt(sidesStr) + (parseInt(plusStr) || 0) - (parseInt(minusStr) || 0);
};

const calcDerived = (c) => {
    const hp = Math.floor((c.con + c.siz) / 10);
    const mov = c.str < c.siz && c.dex < c.siz ? 7 : c.str > c.siz && c.dex > c.siz ? 9 : 8;
    const sum = c.str + c.siz;
    let db = '0', build = 0;
    if (sum <= 64) { db = '-2'; build = -2; }
    else if (sum <= 84) { db = '-1'; build = -1; }
    else if (sum <= 124) { db = '0'; build = 0; }
    else if (sum <= 164) { db = '1D4'; build = 1; }
    else if (sum <= 204) { db = '1D6'; build = 2; }
    else if (sum <= 284) { db = '2D6'; build = 3; }
    else { db = '3D6'; build = 4; }
    return { maxHp: hp, mov, db, build };
};

const calculateSuccessLevel = (roll, skill) => {
    if (roll === 1) return 4;
    if (roll <= Math.floor(skill / 5)) return 3;
    if (roll <= Math.floor(skill / 2)) return 2;
    if (roll <= skill) return 1;
    if (skill < 50 && roll >= 96) return -1;
    if (roll === 100) return -1;
    return 0;
};

const getSuccessLabel = (level) => ({ 4: 'å¤§æˆåŠŸ', 3: 'æéš¾æˆåŠŸ', 2: 'å›°éš¾æˆåŠŸ', 1: 'å¸¸è§„æˆåŠŸ', 0: 'å¤±è´¥', '-1': 'å¤§å¤±è´¥' }[level] || 'æœªçŸ¥');

const executeOpposedCheck = (atkSkill, defSkill, atkRoll, defRoll, defType) => {
    const atkLvl = calculateSuccessLevel(atkRoll, atkSkill);
    const defLvl = calculateSuccessLevel(defRoll, defSkill);
    if (atkLvl > defLvl) return { success: true, winner: 'attacker', atkLvl, defLvl };
    if (defLvl > atkLvl) return { success: false, winner: 'defender', atkLvl, defLvl };
    return { success: defType === 'counter', winner: defType === 'counter' ? 'attacker' : 'defender', atkLvl, defLvl, isTie: true };
};

const calculateDamage = (weapon, attacker, successLevel, isCounterAttack) => {
    if (isCounterAttack) successLevel = Math.min(successLevel, 2);
    const wDmg = rollDice(weapon.damage);
    const dbDmg = attacker.db !== '0' ? rollDice(attacker.db) : { total: 0, rolls: [] };
    let total = wDmg.total + dbDmg.total;
    let log = `${wDmg.total}(æ­¦å™¨)`;
    if (dbDmg.total !== 0) log += ` + ${dbDmg.total}(DB)`;
    
    if (successLevel >= 3) {
        const maxW = getMaxDamage(weapon.damage);
        const maxDB = attacker.db !== '0' ? getMaxDamage(attacker.db) : 0;
        if (weapon.impale) {
            const extra = rollDice(weapon.damage);
            total = maxW + maxDB + extra.total;
            log = `${maxW}(æœ€å¤§)+${maxDB}(DB)+${extra.total}(è´¯ç©¿)`;
        } else {
            total = maxW + maxDB;
            log = `${maxW}(æœ€å¤§)+${maxDB}(DB)`;
        }
    }
    return { total: Math.max(0, total), damageLog: log };
};

// å¥–åŠ±éª°/æƒ©ç½šéª°è®¡ç®— - åˆ†æ­¥éª¤ç‰ˆæœ¬
const rollBasicDice = () => {
    const units = Math.floor(Math.random() * 10); // ä¸ªä½ 0-9
    const tens = Math.floor(Math.random() * 10) * 10; // åä½ 00-90
    const result = (tens + units) || 100; // 00+0 = 100
    return { units, tens, result };
};

const rollExtraTens = () => {
    return Math.floor(Math.random() * 10) * 10;
};

// è®¡ç®—æœ€ç»ˆç»“æœ
const calculateFinalResult = (units, tens1, tens2, modifier) => {
    const roll1 = (tens1 + units) || 100;
    const roll2 = (tens2 + units) || 100;
    
    if (modifier === 'bonus') {
        // å¥–åŠ±éª°ï¼šå–å°
        return roll1 < roll2 
            ? { finalResult: roll1, chosenTens: tens1, discardedTens: tens2 }
            : { finalResult: roll2, chosenTens: tens2, discardedTens: tens1 };
    } else if (modifier === 'penalty') {
        // æƒ©ç½šéª°ï¼šå–å¤§
        return roll1 > roll2 
            ? { finalResult: roll1, chosenTens: tens1, discardedTens: tens2 }
            : { finalResult: roll2, chosenTens: tens2, discardedTens: tens1 };
    }
    return { finalResult: roll1, chosenTens: tens1, discardedTens: null };
};

// æ—§ç‰ˆå…¼å®¹å‡½æ•°
const rollWithModifier = (modifier) => {
    const units = Math.floor(Math.random() * 10); // ä¸ªä½ 0-9
    const tens1 = Math.floor(Math.random() * 10) * 10; // ç¬¬ä¸€ä¸ªåä½
    const tens2 = Math.floor(Math.random() * 10) * 10; // ç¬¬äºŒä¸ªåä½
    
    const roll1 = tens1 + units || 100; // 00+0 = 100
    const roll2 = tens2 + units || 100;
    
    if (modifier === 'bonus') {
        // å¥–åŠ±éª°ï¼šå–å°
        const result = Math.min(roll1, roll2);
        return { result, roll1, roll2, type: 'bonus' };
    } else if (modifier === 'penalty') {
        // æƒ©ç½šéª°ï¼šå–å¤§
        const result = Math.max(roll1, roll2);
        return { result, roll1, roll2, type: 'penalty' };
    } else {
        return { result: roll1, roll1, roll2: null, type: 'normal' };
    }
};

const generateId = () => Math.random().toString(36).substr(2, 9);

// =====================================================
// ğŸ”‘ CustomNumPad - çº¯é»‘æ•°å­—é”®ç›˜ï¼ˆæ ¸å¿ƒç»„ä»¶ï¼‰
// =====================================================
function CustomNumPad({ isOpen, value, onChange, onConfirm, onClose, label, quickActions }) {
    if (!isOpen) return null;
    
    const handleKey = (key) => {
        if (key === 'back') {
            onChange(value.slice(0, -1));
        } else if (key === 'clear') {
            onChange('');
        } else {
            onChange(value + key);
        }
    };

    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘å…¶ä»–ç‚¹å‡»
    const stopProp = (e) => e.stopPropagation();

    return (
        <div className="numpad-overlay" onClick={onClose}>
            <div className="numpad-container" onClick={stopProp}>
                {label && <div className="numpad-label">{label}</div>}
                <div className="numpad-display">{value || '0'}</div>
                <div className="numpad-grid">
                    {['7','8','9','4','5','6','1','2','3','C','0','âœ“'].map(k => (
                        <button 
                            key={k} 
                            className={`numpad-btn ${k === 'âœ“' ? 'confirm' : ''}`}
                            onClick={() => {
                                if (k === 'âœ“') onConfirm();
                                else if (k === 'C') handleKey('clear');
                                else handleKey(k);
                            }}
                        >
                            {k === 'C' ? 'â†' : k}
                        </button>
                    ))}
                </div>
                {quickActions && quickActions.length > 0 && (
                    <div className="numpad-quick">
                        {quickActions.map((action, i) => (
                            <button key={i} onClick={action.action}>{action.label}</button>
                        ))}
                    </div>
                )}
            </div>
        </div>
    );
}

// =====================================================
// ğŸ”‘ SmartInput - æ™ºèƒ½è¾“å…¥ï¼ˆæ•°å€¼å‹ä¸è§¦å‘åŸç”Ÿé”®ç›˜ï¼‰
// =====================================================
function SmartInput({ type = 'number', value, onChange, label, readonly = false, placeholder }) {
    const [numPadOpen, setNumPadOpen] = useState(false);
    const [tempValue, setTempValue] = useState(String(value ?? ''));
    
    useEffect(() => {
        setTempValue(String(value ?? ''));
    }, [value]);

    // æ–‡æœ¬ç±»å‹ï¼šä½¿ç”¨åŸç”Ÿinput
    if (type === 'text') {
        return (
            <div className="smart-input-container">
                {label && <div className="smart-input-label">{label}</div>}
                <input 
                    type="text" 
                    value={value || ''} 
                    onChange={e => onChange(e.target.value)}
                    placeholder={placeholder}
                    className="smart-input-value"
                    style={{ cursor: 'text' }}
                />
            </div>
        );
    }

    // æ•°å€¼ç±»å‹ï¼šç‚¹å‡»æ‰“å¼€NumPadï¼ˆä¸è§¦å‘åŸç”Ÿé”®ç›˜ï¼ï¼‰
    return (
        <div className="smart-input-container">
            {label && <div className="smart-input-label">{label}</div>}
            <div 
                className={`smart-input-value ${readonly ? 'readonly' : ''}`}
                onClick={() => {
                    if (!readonly) {
                        setTempValue(String(value ?? ''));
                        setNumPadOpen(true);
                    }
                }}
            >
                {value ?? '-'}
            </div>
            {!readonly && (
                <CustomNumPad 
                    isOpen={numPadOpen}
                    value={tempValue}
                    onChange={setTempValue}
                    onConfirm={() => { 
                        onChange(parseInt(tempValue) || 0); 
                        setNumPadOpen(false); 
                    }}
                    onClose={() => setNumPadOpen(false)}
                    label={label}
                    quickActions={[
                        { label: '+5', action: () => setTempValue(String((parseInt(tempValue)||0)+5)) },
                        { label: '-5', action: () => setTempValue(String(Math.max(0,(parseInt(tempValue)||0)-5))) },
                        { label: '+10', action: () => setTempValue(String((parseInt(tempValue)||0)+10)) },
                    ]}
                />
            )}
        </div>
    );
}

// =====================================================
// StatusGrid - çŠ¶æ€ç½‘æ ¼
// =====================================================
function StatusGrid({ status, onChange }) {
    const statuses = [
        { key: 'majorWound', label: 'é‡ä¼¤', type: 'danger' },
        { key: 'dying', label: 'æ¿’æ­»', type: 'danger' },
        { key: 'unconscious', label: 'æ˜è¿·', type: 'dark' },
        { key: 'prone', label: 'å€’åœ°', type: 'dark' },
    ];

    return (
        <div className="status-grid">
            {statuses.map(s => (
                <button
                    key={s.key}
                    className={`status-btn ${status[s.key] ? (s.type === 'danger' ? 'active-danger' : 'active-dark') : ''}`}
                    onClick={() => onChange({ ...status, [s.key]: !status[s.key] })}
                >
                    {s.label}
                </button>
            ))}
        </div>
    );
}

// =====================================================
// DiceModifierSelector - å¥–åŠ±/æƒ©ç½šéª°é€‰æ‹©å™¨
// =====================================================
function DiceModifierSelector({ value, onChange }) {
    return (
        <div className="dice-modifier-selector">
            <button 
                className={`dice-modifier-btn ${value === 'bonus' ? 'active' : ''}`}
                onClick={() => onChange('bonus')}
            >
                ğŸ å¥–åŠ±éª°
            </button>
            <button 
                className={`dice-modifier-btn ${value === 'normal' ? 'active' : ''}`}
                onClick={() => onChange('normal')}
            >
                æ ‡å‡†
            </button>
            <button 
                className={`dice-modifier-btn ${value === 'penalty' ? 'active' : ''}`}
                onClick={() => onChange('penalty')}
            >
                ğŸ’€ æƒ©ç½šéª°
            </button>
        </div>
    );
}

// =====================================================
// ğŸ² StepDiceRoller - åˆ†æ­¥éª¤éª°å­åŠ¨ç”»ç»„ä»¶
// =====================================================
function StepDiceRoller({ isOpen, modifier, targetNumber, onComplete, onClose }) {
    const [step, setStep] = useState(0);
    // step 0: å‡†å¤‡æŠ•éª°
    // step 1: åŸºç¡€éª°æ»šåŠ¨ä¸­
    // step 2: åŸºç¡€éª°ç»“æœæ˜¾ç¤º
    // step 3: é¢å¤–åä½éª°æ»šåŠ¨ä¸­ (ä»…å¥–åŠ±/æƒ©ç½š)
    // step 4: æœ€ç»ˆç»“æœ
    
    const [units, setUnits] = useState(null);
    const [tens1, setTens1] = useState(null);
    const [tens2, setTens2] = useState(null);
    const [finalResult, setFinalResult] = useState(null);
    const [isRolling, setIsRolling] = useState(false);

    useEffect(() => {
        if (isOpen) {
            setStep(0);
            setUnits(null);
            setTens1(null);
            setTens2(null);
            setFinalResult(null);
            setIsRolling(false);
        }
    }, [isOpen]);

    if (!isOpen) return null;

    const startRoll = () => {
        setStep(1);
        setIsRolling(true);
        
        // æ¨¡æ‹Ÿæ»šåŠ¨åŠ¨ç”»
        let rollCount = 0;
        const rollInterval = setInterval(() => {
            setUnits(Math.floor(Math.random() * 10));
            setTens1(Math.floor(Math.random() * 10) * 10);
            rollCount++;
            if (rollCount >= 10) {
                clearInterval(rollInterval);
                // æœ€ç»ˆç»“æœ
                const finalUnits = Math.floor(Math.random() * 10);
                const finalTens = Math.floor(Math.random() * 10) * 10;
                setUnits(finalUnits);
                setTens1(finalTens);
                setIsRolling(false);
                setStep(2);
            }
        }, 80);
    };

    const rollExtraDice = () => {
        setStep(3);
        setIsRolling(true);
        
        let rollCount = 0;
        const rollInterval = setInterval(() => {
            setTens2(Math.floor(Math.random() * 10) * 10);
            rollCount++;
            if (rollCount >= 10) {
                clearInterval(rollInterval);
                const finalTens2 = Math.floor(Math.random() * 10) * 10;
                setTens2(finalTens2);
                setIsRolling(false);
                
                // è®¡ç®—æœ€ç»ˆç»“æœ
                const result = calculateFinalResult(units, tens1, finalTens2, modifier);
                setFinalResult(result.finalResult);
                setStep(4);
            }
        }, 80);
    };

    const confirmResult = () => {
        const result = modifier === 'normal' 
            ? ((tens1 + units) || 100)
            : finalResult;
        onComplete(result);
        onClose();
    };

    const basicResult = (tens1 !== null && units !== null) ? ((tens1 + units) || 100) : null;
    const modifierLabel = modifier === 'bonus' ? 'ğŸ å¥–åŠ±éª°' : modifier === 'penalty' ? 'ğŸ’€ æƒ©ç½šéª°' : 'ğŸ² æ ‡å‡†éª°';
    
    // åˆ¤æ–­æˆåŠŸç­‰çº§
    const getResultClass = (roll) => {
        if (roll === null || targetNumber === null) return '';
        return roll <= targetNumber ? 'success' : 'fail';
    };

    return (
        <div className="step-dice-overlay" onClick={(e) => { if (step === 0) onClose(); }}>
            <div className="step-dice-container" onClick={e => e.stopPropagation()}>
                <div className="step-dice-title">{modifierLabel}</div>
                
                {/* Step 0: å‡†å¤‡æŠ•éª° */}
                {step === 0 && (
                    <>
                        <div className="step-dice-display">
                            <div className="dice-block tens">?</div>
                            <div className="dice-block">?</div>
                        </div>
                        {targetNumber && (
                            <div style={{ color: '#9ca3af', fontSize: '12px', marginBottom: '8px' }}>
                                ç›®æ ‡å€¼: <span style={{ color: '#fff', fontWeight: 'bold' }}>{targetNumber}</span>
                            </div>
                        )}
                        <button className="step-dice-btn" onClick={startRoll}>
                            ğŸ² æŠ•æ·åŸºç¡€éª°
                        </button>
                    </>
                )}

                {/* Step 1: åŸºç¡€éª°æ»šåŠ¨ä¸­ */}
                {step === 1 && (
                    <>
                        <div className="step-dice-display">
                            <div className={`dice-block tens ${isRolling ? 'rolling' : ''}`}>
                                {tens1 !== null ? String(tens1 / 10) : '?'}
                            </div>
                            <div className={`dice-block ${isRolling ? 'rolling' : ''}`}>
                                {units !== null ? units : '?'}
                            </div>
                        </div>
                        <div style={{ color: '#fff', fontSize: '14px' }}>æ­£åœ¨æŠ•æ·...</div>
                    </>
                )}

                {/* Step 2: åŸºç¡€éª°ç»“æœ */}
                {step === 2 && (
                    <>
                        <div className="step-dice-display">
                            <div className="dice-block tens">{String(tens1 / 10)}</div>
                            <div className="dice-block">{units}</div>
                        </div>
                        <div className={`step-dice-result ${getResultClass(basicResult)}`}>
                            {basicResult}
                        </div>
                        {targetNumber && (
                            <div style={{ color: '#9ca3af', fontSize: '12px' }}>
                                {basicResult <= targetNumber ? 'âœ“ æˆåŠŸ' : 'âœ— å¤±è´¥'} (ç›®æ ‡ â‰¤{targetNumber})
                            </div>
                        )}
                        
                        {modifier === 'normal' ? (
                            <button className="step-dice-btn" onClick={confirmResult}>
                                ç¡®è®¤ç»“æœ
                            </button>
                        ) : (
                            <>
                                <div className="step-dice-explanation">
                                    {modifier === 'bonus' 
                                        ? 'å¥–åŠ±éª°ï¼šæŠ•æ·é¢å¤–åä½éª°ï¼Œå–è¾ƒå°çš„ç»“æœ'
                                        : 'æƒ©ç½šéª°ï¼šæŠ•æ·é¢å¤–åä½éª°ï¼Œå–è¾ƒå¤§çš„ç»“æœ'}
                                </div>
                                <button className="step-dice-btn" onClick={rollExtraDice}>
                                    ğŸ² æŠ•æ·é¢å¤–åä½éª°
                                </button>
                            </>
                        )}
                    </>
                )}

                {/* Step 3: é¢å¤–åä½éª°æ»šåŠ¨ä¸­ */}
                {step === 3 && (
                    <>
                        <div className="step-dice-display">
                            <div className="dice-block tens">{String(tens1 / 10)}</div>
                            <div className="dice-block">{units}</div>
                            <div style={{ fontSize: '24px', color: '#fff', alignSelf: 'center' }}>+</div>
                            <div className={`dice-block extra ${isRolling ? 'rolling' : ''}`}>
                                {tens2 !== null ? String(tens2 / 10) : '?'}
                            </div>
                        </div>
                        <div style={{ color: '#fff', fontSize: '14px' }}>æ­£åœ¨æŠ•æ·é¢å¤–åä½éª°...</div>
                    </>
                )}

                {/* Step 4: æœ€ç»ˆç»“æœ */}
                {step === 4 && (
                    <>
                        <div className="step-dice-display">
                            {(() => {
                                const result1 = (tens1 + units) || 100;
                                const result2 = (tens2 + units) || 100;
                                const isFirstChosen = (modifier === 'bonus' && result1 <= result2) || 
                                                     (modifier === 'penalty' && result1 >= result2);
                                return (
                                    <>
                                        <div className={`dice-block tens ${isFirstChosen ? 'highlight-good' : 'highlight-bad'}`}>
                                            {String(tens1 / 10)}
                                        </div>
                                        <div className="dice-block">{units}</div>
                                        <div style={{ fontSize: '16px', color: '#666', alignSelf: 'center', padding: '0 4px' }}>VS</div>
                                        <div className={`dice-block extra ${!isFirstChosen ? 'highlight-good' : 'highlight-bad'}`}>
                                            {String(tens2 / 10)}
                                        </div>
                                        <div className="dice-block">{units}</div>
                                    </>
                                );
                            })()}
                        </div>
                        
                        <div style={{ color: '#9ca3af', fontSize: '11px', margin: '8px 0' }}>
                            [{(tens1 + units) || 100}] vs [{(tens2 + units) || 100}] â†’ å–{modifier === 'bonus' ? 'å°' : 'å¤§'}
                        </div>
                        
                        <div className={`step-dice-result ${getResultClass(finalResult)}`}>
                            {finalResult}
                        </div>
                        
                        {targetNumber && (
                            <div style={{ color: '#9ca3af', fontSize: '12px' }}>
                                {finalResult <= targetNumber ? 'âœ“ æˆåŠŸ' : 'âœ— å¤±è´¥'} (ç›®æ ‡ â‰¤{targetNumber})
                            </div>
                        )}
                        
                        <button className="step-dice-btn" onClick={confirmResult}>
                            ç¡®è®¤ç»“æœ
                        </button>
                    </>
                )}
            </div>
        </div>
    );
}

// =====================================================
// App ä¸»ç»„ä»¶
// =====================================================
function App() {
    const [view, setView] = useState('setup');
    const [characters, setCharacters] = useState([]);
    const [logs, setLogs] = useState([]);
    const [drawerOpen, setDrawerOpen] = useState(false);
    const [turn, setTurn] = useState({ round: 1, index: 0 });
    const [history, setHistory] = useState([]);
    const [kpPanelOpen, setKpPanelOpen] = useState(false);
    const logContainerRef = useRef(null);

    useEffect(() => {
        if (logContainerRef.current) {
            logContainerRef.current.scrollTop = logContainerRef.current.scrollHeight;
        }
    }, [logs]);

    const saveToHistory = () => {
        setHistory(prev => [...prev.slice(-19), {
            characters: JSON.parse(JSON.stringify(characters)),
            turn: { ...turn },
            logs: [...logs]
        }]);
    };

    const undo = () => {
        if (history.length === 0) return;
        const last = history[history.length - 1];
        setCharacters(last.characters);
        setTurn(last.turn);
        setLogs(last.logs);
        setHistory(prev => prev.slice(0, -1));
    };

    const addLog = (text, type = 'info') => {
        setLogs(prev => [...prev, { id: Date.now(), text, type, time: new Date().toLocaleTimeString().slice(0, 8) }]);
    };

    const combatOrder = useMemo(() => [...characters].sort((a, b) => {
        const aDex = a.hasGunReady ? a.dex + 50 : a.dex;
        const bDex = b.hasGunReady ? b.dex + 50 : b.dex;
        return bDex !== aDex ? bDex - aDex : b.fight - a.fight;
    }), [characters]);

    const currentActor = useMemo(() => combatOrder[turn.index % combatOrder.length], [combatOrder, turn.index]);

    const updateChar = (id, updates) => {
        setCharacters(prev => prev.map(c => {
            if (c.id !== id) return c;
            const updated = { ...c, ...updates };
            const derived = calcDerived(updated);
            return { ...updated, ...derived, hp: Math.min(updated.hp ?? derived.maxHp, derived.maxHp) };
        }));
    };

    const startNewRound = () => {
        setCharacters(prev => prev.map(c => ({ ...c, status: { ...c.status, defenseUsedThisRound: false } })));
    };

    return (
        <div className="main-layout font-sans text-gray-900 bg-white">
            <header className="h-14 border-b-2 border-black flex items-center justify-between px-4 bg-white shrink-0 z-30 relative">
                <div className="flex items-center gap-2">
                    <div className="w-7 h-7 bg-black flex items-center justify-center text-white font-bold text-xs">C7</div>
                    <h1 className="font-bold text-sm hidden sm:block">COC7 COMBAT CONSOLE <span className="text-gray-400 font-normal">v3.1</span></h1>
                    <h1 className="font-bold text-sm sm:hidden">COC7</h1>
                </div>
                <div className="flex items-center gap-2">
                    {view === 'setup' && (
                        <button onClick={() => { if(characters.length<1) return alert("è‡³å°‘æ·»åŠ ä¸€ä¸ªè§’è‰²"); setView('combat'); addLog("ğŸ æˆ˜æ–—å¼€å§‹", "system"); }} className="bg-black text-white px-4 py-2 text-xs font-bold uppercase tracking-wide">âš”ï¸ START</button>
                    )}
                    {view === 'combat' && (
                        <>
                            <span className="font-mono text-xs bg-black text-white px-2 py-1">R{turn.round}</span>
                            <button onClick={() => setKpPanelOpen(!kpPanelOpen)} className={`font-bold text-xs px-2 py-1 border-2 ${kpPanelOpen ? 'bg-red-600 text-white border-red-600' : 'border-black hover:bg-black hover:text-white'}`}>ğŸ‘‘ KP</button>
                            <button onClick={undo} disabled={history.length === 0} className="font-bold text-xs px-2 py-1 border-2 border-black disabled:opacity-30">â†©</button>
                            <button onClick={() => setView('setup')} className="text-xs underline">SETUP</button>
                        </>
                    )}
                </div>
            </header>

            <main className="flex-1 overflow-hidden relative">
                {view === 'setup' ? (
                    <SetupModule characters={characters} setCharacters={setCharacters} updateChar={updateChar} />
                ) : (
                    <CombatModule 
                        characters={characters} 
                        combatOrder={combatOrder}
                        updateChar={updateChar}
                        turn={turn} 
                        setTurn={setTurn}
                        logs={logs}
                        addLog={addLog}
                        currentActor={currentActor}
                        startNewRound={startNewRound}
                        saveToHistory={saveToHistory}
                        logContainerRef={logContainerRef}
                    />
                )}
                
                <KPControlPanel 
                    isOpen={kpPanelOpen} 
                    onClose={() => setKpPanelOpen(false)}
                    characters={characters}
                    updateChar={updateChar}
                    addLog={addLog}
                    currentActor={currentActor}
                    setCharacters={setCharacters}
                />
            </main>
        </div>
    );
}

// =====================================================
// KPæ§åˆ¶å° - å«è‡ªå®šä¹‰æ­¦å™¨åŠŸèƒ½
// =====================================================
function KPControlPanel({ isOpen, onClose, characters, updateChar, addLog, currentActor, setCharacters }) {
    const [selectedCharId, setSelectedCharId] = useState('');
    const [editMode, setEditMode] = useState('stats');
    // è‡ªå®šä¹‰æ­¦å™¨è¡¨å•
    const [customWeaponName, setCustomWeaponName] = useState('');
    const [customWeaponDamage, setCustomWeaponDamage] = useState('1D6');
    const [customWeaponType, setCustomWeaponType] = useState('melee');
    const [customWeaponImpale, setCustomWeaponImpale] = useState(false);
    const [customWeaponRange, setCustomWeaponRange] = useState(10);

    const selectedChar = characters.find(c => c.id === selectedCharId) || currentActor;

    useEffect(() => {
        if (isOpen && !selectedCharId && currentActor) {
            setSelectedCharId(currentActor.id);
        }
    }, [isOpen, currentActor, selectedCharId]);

    const addCustomWeapon = () => {
        if (!selectedChar || !customWeaponName.trim()) return;
        const newWeapon = {
            id: generateId(),
            name: customWeaponName.trim(),
            damage: customWeaponDamage,
            type: customWeaponType,
            impale: customWeaponImpale,
            range: customWeaponType === 'ranged' ? customWeaponRange : 1,
            ammo: customWeaponType === 'ranged' ? 10 : undefined,
            maxAmmo: customWeaponType === 'ranged' ? 10 : undefined,
            malfunction: 100,
        };
        
        if (customWeaponType === 'melee') {
            updateChar(selectedChar.id, { meleeWeapon: newWeapon });
        } else {
            updateChar(selectedChar.id, { rangedWeapon: newWeapon });
        }
        addLog(`ğŸ‘‘ KPä¸º${selectedChar.name}æ·»åŠ æ­¦å™¨: ${newWeapon.name}`, 'system');
        setCustomWeaponName('');
    };

    const quickActions = {
        heal: (amount) => {
            if (selectedChar) {
                const newHp = Math.min(selectedChar.maxHp, selectedChar.hp + amount);
                updateChar(selectedChar.id, { hp: newHp });
                addLog(`ğŸ‘‘ +${amount}HP â†’ ${selectedChar.name}`, 'system');
            }
        },
        damage: (amount) => {
            if (selectedChar) {
                const newHp = Math.max(0, selectedChar.hp - amount);
                updateChar(selectedChar.id, { hp: newHp });
                addLog(`ğŸ‘‘ -${amount}HP â†’ ${selectedChar.name}`, 'damage');
            }
        },
    };

    return (
        <div className={`kp-panel ${isOpen ? 'open' : ''}`}>
            <div className="p-4 bg-red-600 text-white flex justify-between items-center">
                <h2 className="font-bold uppercase tracking-wide">ğŸ‘‘ KP CONSOLE</h2>
                <button onClick={onClose} className="text-2xl leading-none">Ã—</button>
            </div>

            <div className="p-4">
                <div className="mb-4">
                    <div className="label mb-1">SELECT CHARACTER</div>
                    <select 
                        value={selectedCharId} 
                        onChange={(e) => setSelectedCharId(e.target.value)}
                        className="w-full border-2 border-black px-3 py-2 text-sm"
                    >
                        {characters.map(c => (
                            <option key={c.id} value={c.id}>{c.name} ({c.type === 'player' ? 'PC' : 'NPC'})</option>
                        ))}
                    </select>
                </div>

                {selectedChar && (
                    <>
                        <div className="flex border-b-2 border-black mb-4">
                            {['stats', 'weapons'].map(mode => (
                                <button
                                    key={mode}
                                    onClick={() => setEditMode(mode)}
                                    className={`flex-1 py-2 text-xs font-bold uppercase ${editMode === mode ? 'bg-black text-white' : ''}`}
                                >
                                    {mode === 'stats' ? 'å±æ€§' : 'æ­¦å™¨'}
                                </button>
                            ))}
                        </div>

                        {editMode === 'stats' && (
                            <div className="space-y-4">
                                <div className="grid grid-cols-4 gap-2">
                                    <button onClick={() => quickActions.heal(1)} className="p-2 border-2 border-black text-xs font-bold">+1</button>
                                    <button onClick={() => quickActions.heal(5)} className="p-2 border-2 border-black text-xs font-bold">+5</button>
                                    <button onClick={() => quickActions.damage(5)} className="p-2 border-2 border-black text-xs font-bold bg-red-100">-5</button>
                                    <button onClick={() => quickActions.damage(10)} className="p-2 border-2 border-black text-xs font-bold bg-red-100">-10</button>
                                </div>
                                
                                <div>
                                    <div className="label mb-2">STATUS</div>
                                    <StatusGrid status={selectedChar.status} onChange={(status) => updateChar(selectedChar.id, { status })} />
                                </div>

                                <div className="grid grid-cols-2 gap-2">
                                    {['hp','str','con','siz','dex','fight','firearms','dodge','firstAid','medicine'].map(key => (
                                        <SmartInput
                                            key={key}
                                            label={key.toUpperCase()}
                                            value={selectedChar[key]}
                                            onChange={(val) => updateChar(selectedChar.id, { [key]: val })}
                                        />
                                    ))}
                                </div>
                            </div>
                        )}

                        {editMode === 'weapons' && (
                            <div className="space-y-4">
                                <div>
                                    <div className="label mb-2">CURRENT WEAPONS</div>
                                    <div className="text-xs p-2 border-2 border-black mb-1">
                                        <span className="font-bold">MELEE:</span> {selectedChar.meleeWeapon?.name || 'æ‹³å¤´'} ({selectedChar.meleeWeapon?.damage || '1D3'})
                                    </div>
                                    <div className="text-xs p-2 border-2 border-black">
                                        <span className="font-bold">RANGED:</span> {selectedChar.rangedWeapon?.name || 'NONE'} {selectedChar.rangedWeapon ? `(${selectedChar.rangedWeapon.damage})` : ''}
                                    </div>
                                </div>

                                <div>
                                    <div className="label mb-2">PRESET WEAPONS</div>
                                    <select 
                                        onChange={(e) => {
                                            const w = WEAPON_PRESETS.find(w => w.name === e.target.value);
                                            if (w) {
                                                if (w.type === 'melee') updateChar(selectedChar.id, { meleeWeapon: {...w} });
                                                else updateChar(selectedChar.id, { rangedWeapon: {...w} });
                                                addLog(`ğŸ‘‘ ${selectedChar.name} â†’ ${w.name}`, 'system');
                                                e.target.value = '';
                                            }
                                        }}
                                        className="w-full border-2 border-black p-2 text-sm"
                                    >
                                        <option value="">-- SELECT --</option>
                                        <optgroup label="MELEE">{MELEE_WEAPONS.map(w => <option key={w.name} value={w.name}>{w.name}</option>)}</optgroup>
                                        <optgroup label="RANGED">{RANGED_WEAPONS.map(w => <option key={w.name} value={w.name}>{w.name}</option>)}</optgroup>
                                    </select>
                                </div>

                                {/* è‡ªå®šä¹‰æ­¦å™¨è¡¨å• */}
                                <div className="border-t-2 border-dashed border-black pt-4">
                                    <div className="label mb-2">CUSTOM WEAPON</div>
                                    <div className="space-y-2">
                                        <input 
                                            type="text" 
                                            placeholder="æ­¦å™¨åç§°" 
                                            value={customWeaponName}
                                            onChange={e => setCustomWeaponName(e.target.value)}
                                            className="w-full border-2 border-black p-2 text-sm"
                                        />
                                        <input 
                                            type="text" 
                                            placeholder="ä¼¤å®³ (å¦‚ 2D6+2)" 
                                            value={customWeaponDamage}
                                            onChange={e => setCustomWeaponDamage(e.target.value)}
                                            className="w-full border-2 border-black p-2 text-sm font-mono"
                                        />
                                        <div className="flex gap-2">
                                            <select 
                                                value={customWeaponType}
                                                onChange={e => setCustomWeaponType(e.target.value)}
                                                className="flex-1 border-2 border-black p-2 text-sm"
                                            >
                                                <option value="melee">è¿‘æˆ˜</option>
                                                <option value="ranged">è¿œç¨‹</option>
                                            </select>
                                            <label className="flex items-center gap-1 text-sm">
                                                <input type="checkbox" checked={customWeaponImpale} onChange={e => setCustomWeaponImpale(e.target.checked)} />
                                                è´¯ç©¿
                                            </label>
                                        </div>
                                        <button onClick={addCustomWeapon} className="w-full bg-black text-white p-2 font-bold text-sm uppercase">
                                            + ADD WEAPON
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </>
                )}
            </div>
        </div>
    );
}

// =====================================================
// SetupModule - è®¾ç½®æ¨¡å—
// =====================================================
function SetupModule({ characters, setCharacters, updateChar }) {
    const [selectedId, setSelectedId] = useState(null);
    const [isImporting, setIsImporting] = useState(false);
    const [importText, setImportText] = useState('');
    
    const activeChar = characters.find(c => c.id === selectedId);

    const addCharacter = (type) => {
        const newChar = { 
            ...JSON.parse(JSON.stringify(BASE_CHARACTER)), 
            id: generateId(), 
            type, 
            name: type === 'player' ? 'æ–°è°ƒæŸ¥å‘˜' : 'æ–°æ•Œäºº',
        };
        const derived = calcDerived(newChar);
        setCharacters(p => [...p, { ...newChar, ...derived, hp: derived.maxHp }]);
        setSelectedId(newChar.id);
    };

    const handleImport = () => {
        if (!importText) return;
        const lines = importText.split('\n');
        const newChar = { ...JSON.parse(JSON.stringify(BASE_CHARACTER)), id: generateId(), type: 'player', name: 'å¯¼å…¥è§’è‰²' };
        lines.forEach(line => {
            if (line.includes('åŠ›é‡')) newChar.str = parseInt(line.match(/\d+/)?.[0] || 50);
            if (line.includes('ä½“è´¨')) newChar.con = parseInt(line.match(/\d+/)?.[0] || 50);
            if (line.includes('ä½“å‹')) newChar.siz = parseInt(line.match(/\d+/)?.[0] || 60);
            if (line.includes('æ•æ·')) newChar.dex = parseInt(line.match(/\d+/)?.[0] || 50);
            if (line.includes('æ–—æ®´') || line.includes('æ ¼æ–—')) newChar.fight = parseInt(line.match(/\d+/)?.[0] || 50);
            if (line.includes('å°„å‡»')) newChar.firearms = parseInt(line.match(/\d+/)?.[0] || 20);
            if (line.includes('é—ªé¿')) newChar.dodge = parseInt(line.match(/\d+/)?.[0] || 25);
        });
        const derived = calcDerived(newChar);
        setCharacters(p => [...p, { ...newChar, ...derived, hp: derived.maxHp }]);
        setSelectedId(newChar.id);
        setImportText('');
        setIsImporting(false);
    };

    return (
        <div className="setup-grid h-full">
            <div className="setup-sidebar panel-scroll">
                <div className="p-3 space-y-4">
                    {isImporting ? (
                        <div className="p-2 border-2 border-black">
                            <textarea className="w-full h-20 text-xs font-mono border border-black p-1 mb-2" placeholder="ç²˜è´´ .st æ–‡æœ¬..." value={importText} onChange={e => setImportText(e.target.value)} />
                            <div className="flex gap-2">
                                <button onClick={handleImport} className="flex-1 bg-black text-white text-xs py-1 font-bold">IMPORT</button>
                                <button onClick={() => setIsImporting(false)} className="flex-1 border border-black text-xs py-1">CANCEL</button>
                            </div>
                        </div>
                    ) : (
                        <button onClick={() => setIsImporting(true)} className="w-full py-2 border-2 border-dashed border-black text-xs font-bold uppercase hover:bg-black hover:text-white">ğŸ“¥ IMPORT .ST</button>
                    )}
                    
                    <div>
                        <div className="flex justify-between items-center mb-2">
                            <span className="label">PLAYERS</span>
                            <button onClick={() => addCharacter('player')} className="text-xs font-bold px-2 border border-black hover:bg-black hover:text-white">+</button>
                        </div>
                        <div className="space-y-1">
                            {characters.filter(c => c.type === 'player').map(c => (
                                <div 
                                    key={c.id} 
                                    onClick={() => setSelectedId(c.id)} 
                                    className={`char-card faction-strip-player flex items-center justify-between px-2 py-2 text-xs ${selectedId === c.id ? 'selected' : ''}`}
                                >
                                    <span className="font-bold truncate">{c.name}</span>
                                    <button onClick={(e) => { e.stopPropagation(); setCharacters(p => p.filter(x => x.id !== c.id)); if(selectedId === c.id) setSelectedId(null); }} className="opacity-50 hover:opacity-100">Ã—</button>
                                </div>
                            ))}
                        </div>
                    </div>
                    
                    <div>
                        <div className="flex justify-between items-center mb-2">
                            <span className="label">ENEMIES</span>
                            <button onClick={() => addCharacter('enemy')} className="text-xs font-bold px-2 border border-black hover:bg-black hover:text-white">+</button>
                        </div>
                        <div className="space-y-1">
                            {characters.filter(c => c.type === 'enemy').map(c => (
                                <div 
                                    key={c.id} 
                                    onClick={() => setSelectedId(c.id)} 
                                    className={`char-card faction-strip-enemy flex items-center justify-between px-2 py-2 text-xs ${selectedId === c.id ? 'selected' : ''}`}
                                >
                                    <span className="font-bold truncate">{c.name}</span>
                                    <button onClick={(e) => { e.stopPropagation(); setCharacters(p => p.filter(x => x.id !== c.id)); if(selectedId === c.id) setSelectedId(null); }} className="opacity-50 hover:opacity-100">Ã—</button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
            
            <div className="setup-content panel-scroll">
                {activeChar ? <CharacterSheet char={activeChar} updateChar={updateChar} /> : (
                    <div className="h-full flex items-center justify-center text-gray-400">
                        <div className="text-center">
                            <div className="text-4xl mb-2">ğŸ“‹</div>
                            <p className="text-sm uppercase font-bold">Select or Create</p>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
}

// =====================================================
// ğŸ”‘ CharacterSheet - å…¨éƒ¨ä½¿ç”¨ SmartInputï¼
// =====================================================
function CharacterSheet({ char, updateChar }) {
    return (
        <div className="max-w-2xl mx-auto p-6">
            {/* åå­—ç”¨æ–‡æœ¬è¾“å…¥ */}
            <div className="mb-6 flex gap-4 items-end">
                <div className="flex-1">
                    <SmartInput 
                        type="text" 
                        label="NAME" 
                        value={char.name} 
                        onChange={(val) => updateChar(char.id, { name: val })} 
                    />
                </div>
                <div className="w-28">
                    <div className="label mb-1">TYPE</div>
                    <select value={char.type} onChange={e => updateChar(char.id, { type: e.target.value })} className="w-full py-2 border-2 border-black text-sm font-bold uppercase">
                        <option value="player">PLAYER</option>
                        <option value="enemy">ENEMY</option>
                    </select>
                </div>
            </div>
            
            {/* ğŸ”‘ æ‰€æœ‰æ•°å€¼å…¨éƒ¨ä½¿ç”¨ SmartInput */}
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
                <SmartInput label="STR" value={char.str} onChange={(val) => updateChar(char.id, { str: val })} />
                <SmartInput label="CON" value={char.con} onChange={(val) => updateChar(char.id, { con: val })} />
                <SmartInput label="SIZ" value={char.siz} onChange={(val) => updateChar(char.id, { siz: val })} />
                <SmartInput label="DEX" value={char.dex} onChange={(val) => updateChar(char.id, { dex: val })} />
            </div>

            <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
                <SmartInput label="MAX HP" value={char.maxHp} readonly />
                <div className="smart-input-container">
                    <div className="smart-input-label">DB</div>
                    <div className="smart-input-value readonly">{char.db}</div>
                </div>
                <SmartInput label="BUILD" value={char.build} readonly />
                <SmartInput label="MOV" value={char.mov} readonly />
            </div>

            <div className="border-t-2 border-dashed border-black pt-4 mb-6">
                <div className="label mb-3">COMBAT SKILLS</div>
                <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                    <SmartInput label="æ ¼æ–—" value={char.fight} onChange={(val) => updateChar(char.id, { fight: val })} />
                    <SmartInput label="é—ªé¿" value={char.dodge} onChange={(val) => updateChar(char.id, { dodge: val })} />
                    <SmartInput label="å°„å‡»" value={char.firearms} onChange={(val) => updateChar(char.id, { firearms: val })} />
                    <SmartInput label="æŠ¤ç”²" value={char.armorValue || 0} onChange={(val) => updateChar(char.id, { armorValue: val })} />
                </div>
            </div>

            <div className="border-t-2 border-dashed border-black pt-4 mb-6">
                <div className="label mb-3">MEDICAL SKILLS</div>
                <div className="grid grid-cols-2 gap-3">
                    <SmartInput label="æ€¥æ•‘" value={char.firstAid || 30} onChange={(val) => updateChar(char.id, { firstAid: val })} />
                    <SmartInput label="åŒ»å­¦" value={char.medicine || 5} onChange={(val) => updateChar(char.id, { medicine: val })} />
                </div>
            </div>
            
            <div className="mb-6">
                <label className="flex items-center gap-2 cursor-pointer text-sm font-bold uppercase">
                    <input type="checkbox" checked={char.hasGunReady || false} onChange={e => updateChar(char.id, { hasGunReady: e.target.checked })} className="w-5 h-5" />
                    ğŸ”« GUN READY (DEX+50)
                </label>
            </div>

            <div className="border-t-2 border-dashed border-black pt-4 mb-6">
                <div className="label mb-3">STATUS</div>
                <StatusGrid status={char.status} onChange={(status) => updateChar(char.id, { status })} />
            </div>
            
            <div className="border-t-2 border-dashed border-black pt-4">
                <div className="label mb-3">WEAPONS</div>
                
                <div className="mb-3 p-3 border-2 border-black">
                    <div className="label mb-2 text-blue-600">MELEE WEAPON</div>
                    <select 
                        className="w-full border-2 border-black p-2 text-sm font-bold" 
                        value={char.meleeWeapon?.name || 'æ‹³å¤´'} 
                        onChange={(e) => { 
                            const w = MELEE_WEAPONS.find(w => w.name === e.target.value); 
                            if (w) updateChar(char.id, { meleeWeapon: { ...w } }); 
                        }}
                    >
                        {MELEE_WEAPONS.map(w => <option key={w.name} value={w.name}>{w.name} ({w.damage})</option>)}
                    </select>
                </div>

                <div className="p-3 border-2 border-black">
                    <div className="label mb-2 text-orange-600">RANGED WEAPON</div>
                    <select 
                        className="w-full border-2 border-black p-2 text-sm font-bold" 
                        value={char.rangedWeapon?.name || ''} 
                        onChange={(e) => { 
                            if (!e.target.value) {
                                updateChar(char.id, { rangedWeapon: null });
                            } else {
                                const w = RANGED_WEAPONS.find(w => w.name === e.target.value); 
                                if (w) updateChar(char.id, { rangedWeapon: { ...w } }); 
                            }
                        }}
                    >
                        <option value="">NONE</option>
                        {RANGED_WEAPONS.map(w => <option key={w.name} value={w.name}>{w.name} ({w.damage})</option>)}
                    </select>
                    {char.rangedWeapon && (
                        <div className="mt-2 text-xs font-mono">
                            AMMO: {char.rangedWeapon.ammo}/{char.rangedWeapon.maxAmmo} | RANGE: {char.rangedWeapon.range}yd
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}

// =====================================================
// CombatModule - æˆ˜æ–—æ¨¡å—ï¼ˆå«åŒ»ç–—é¢æ¿ï¼‰
// =====================================================
function CombatModule({ characters, combatOrder, updateChar, turn, setTurn, logs, addLog, currentActor, startNewRound, saveToHistory, logContainerRef }) {
    const [phase, setPhase] = useState('select_action');
    const [selectedTargetId, setSelectedTargetId] = useState(null);
    const [combatAction, setCombatAction] = useState(null);
    const [inputValue, setInputValue] = useState('');
    const [shootingDistance, setShootingDistance] = useState(10);
    const [maneuverType, setManeuverType] = useState('disarm');
    const [mobileTab, setMobileTab] = useState('action');
    const [diceModifier, setDiceModifier] = useState('normal'); // å¥–åŠ±éª°/æƒ©ç½šéª°
    const [showMedical, setShowMedical] = useState(false); // åŒ»ç–—é¢æ¿
    
    // åˆ†æ­¥éª¤éª°å­åŠ¨ç”»çŠ¶æ€
    const [showStepDice, setShowStepDice] = useState(false);
    const [stepDiceCallback, setStepDiceCallback] = useState(null);
    const [stepDiceTargetNumber, setStepDiceTargetNumber] = useState(null);

    const targetActor = characters.find(c => c.id === selectedTargetId);

    const nextTurn = () => {
        saveToHistory();
        const nextIndex = turn.index + 1;
        if (nextIndex >= combatOrder.length) {
            setTurn({ round: turn.round + 1, index: 0 });
            startNewRound();
            addLog(`ğŸ“… ROUND ${turn.round + 1}`, 'system');
        } else {
            setTurn({ ...turn, index: nextIndex });
        }
        setPhase('select_action');
        setSelectedTargetId(null);
        setCombatAction(null);
        setInputValue('');
        setDiceModifier('normal');
        setShowMedical(false);
    };

    // æ‰§è¡Œéª°å­ï¼ˆå«å¥–åŠ±/æƒ©ç½šï¼‰- æ—§ç‰ˆç›´æ¥ç‰ˆæœ¬ï¼Œç”¨äºå†…éƒ¨è°ƒç”¨
    const doRollDirect = () => {
        const result = rollWithModifier(diceModifier);
        if (result.type === 'bonus') {
            addLog(`ğŸ² å¥–åŠ±éª°: [${result.roll1}, ${result.roll2}] â†’ ${result.result}`, 'roll');
        } else if (result.type === 'penalty') {
            addLog(`ğŸ² æƒ©ç½šéª°: [${result.roll1}, ${result.roll2}] â†’ ${result.result}`, 'roll');
        }
        return result.result;
    };

    // æ‰“å¼€åˆ†æ­¥éª¤éª°å­åŠ¨ç”»
    const openStepDiceRoller = (targetNumber, callback) => {
        setStepDiceTargetNumber(targetNumber);
        setStepDiceCallback(() => callback);
        setShowStepDice(true);
    };

    // åˆ†æ­¥éª¤éª°å­å®Œæˆå›è°ƒ
    const handleStepDiceComplete = (result) => {
        // è®°å½•åˆ°æ—¥å¿—
        if (diceModifier === 'bonus') {
            addLog(`ğŸ² å¥–åŠ±éª°: æœ€ç»ˆç»“æœ â†’ ${result}`, 'roll');
        } else if (diceModifier === 'penalty') {
            addLog(`ğŸ² æƒ©ç½šéª°: æœ€ç»ˆç»“æœ â†’ ${result}`, 'roll');
        } else {
            addLog(`ğŸ² æ ‡å‡†éª°: ${result}`, 'roll');
        }
        
        setInputValue(String(result));
        setShowStepDice(false);
        
        if (stepDiceCallback) {
            stepDiceCallback(result);
        }
    };

    const handleMeleeAttack = () => {
        if (!targetActor) return;
        saveToHistory();
        const weapon = currentActor.meleeWeapon || { name: "æ‹³å¤´", damage: "1D3", impale: false };
        setCombatAction({ type: 'melee', attacker: currentActor, target: targetActor, weapon, attackerSkill: currentActor.fight });
        setPhase('waiting_defense');
        addLog(`âš”ï¸ ${currentActor.name} â†’ ${targetActor.name} [${weapon.name}]`, 'system');
    };

    const handleRangedAttack = () => {
        if (!targetActor || !currentActor.rangedWeapon) return;
        if (currentActor.rangedWeapon.ammo <= 0) {
            addLog(`âŒ NO AMMO!`, 'system');
            return;
        }
        saveToHistory();
        const weapon = currentActor.rangedWeapon;
        let difficulty = 'regular';
        if (shootingDistance > weapon.range * 2) difficulty = 'extreme';
        else if (shootingDistance > weapon.range) difficulty = 'hard';
        
        setCombatAction({ type: 'ranged', attacker: currentActor, target: targetActor, weapon, distance: shootingDistance, difficulty });
        setPhase('input_roll');
        addLog(`ğŸ”« ${currentActor.name} â†’ ${targetActor.name} [${weapon.name}] ${difficulty.toUpperCase()}`, 'system');
    };

    const handleManeuver = () => {
        if (!targetActor) return;
        saveToHistory();
        const buildDiff = targetActor.build - currentActor.build;
        if (buildDiff >= 3) {
            addLog(`âŒ BUILDå·®è·è¿‡å¤§(${buildDiff})ï¼Œæˆ˜æŠ€æ— æ•ˆ`, 'system');
            return;
        }
        setCombatAction({ type: 'maneuver', attacker: currentActor, target: targetActor, maneuverType, penaltyDice: Math.max(0, buildDiff), attackerSkill: currentActor.fight });
        setPhase('waiting_defense');
        addLog(`ğŸ¤¼ ${currentActor.name} â†’ ${targetActor.name} [${maneuverType}]`, 'system');
    };

    // åŒ»ç–—åŠŸèƒ½
    const performFirstAid = () => {
        if (!targetActor) return;
        saveToHistory();
        const roll = doRollDirect();
        const success = calculateSuccessLevel(roll, currentActor.firstAid || 30);
        addLog(`ğŸ©¹ æ€¥æ•‘ [${roll}] vs ${currentActor.firstAid || 30} â†’ ${getSuccessLabel(success)}`, 'roll');
        
        if (success > 0) {
            if (targetActor.status.dying) {
                updateChar(targetActor.id, { hp: 1, status: { ...targetActor.status, dying: false } });
                addLog(`âœ… ${targetActor.name} è„±ç¦»æ¿’æ­»`, 'success');
            } else {
                const newHp = Math.min(targetActor.maxHp, targetActor.hp + 1);
                updateChar(targetActor.id, { hp: newHp });
                addLog(`âœ… ${targetActor.name} +1 HP`, 'success');
            }
        }
        nextTurn();
    };

    const performMedicine = () => {
        if (!targetActor) return;
        saveToHistory();
        const roll = doRollDirect();
        const success = calculateSuccessLevel(roll, currentActor.medicine || 5);
        addLog(`âš•ï¸ åŒ»å­¦ [${roll}] vs ${currentActor.medicine || 5} â†’ ${getSuccessLabel(success)}`, 'roll');
        
        if (success > 0) {
            const heal = rollDice('1D3');
            const newHp = Math.min(targetActor.maxHp, targetActor.hp + heal.total);
            updateChar(targetActor.id, { hp: newHp });
            addLog(`âœ… ${targetActor.name} +${heal.total} HP`, 'success');
        }
        nextTurn();
    };

    const handleRoll = () => {
        const roll = parseInt(inputValue);
        if (!roll || roll < 1 || roll > 100) return;
        
        if (combatAction.type === 'ranged') {
            let skillValue = currentActor.firearms;
            if (combatAction.difficulty === 'hard') skillValue = Math.floor(skillValue / 2);
            if (combatAction.difficulty === 'extreme') skillValue = Math.floor(skillValue / 5);
            
            const successLevel = calculateSuccessLevel(roll, skillValue);
            const newAmmo = currentActor.rangedWeapon.ammo - 1;
            updateChar(currentActor.id, { rangedWeapon: { ...currentActor.rangedWeapon, ammo: newAmmo } });
            
            if (roll >= currentActor.rangedWeapon.malfunction) {
                addLog(`ğŸ’¥ MALFUNCTION!`, 'damage');
                nextTurn();
                return;
            }
            
            if (successLevel > 0) {
                addLog(`ğŸ¯ HIT [${roll}] ${getSuccessLabel(successLevel)}`, 'roll');
                setCombatAction(prev => ({ ...prev, damageAttacker: currentActor, damageSuccessLevel: successLevel }));
                setPhase('input_damage');
            } else {
                addLog(`ğŸ’¨ MISS [${roll}]`, 'roll');
                nextTurn();
            }
        } else {
            const successLevel = calculateSuccessLevel(roll, combatAction.attackerSkill);
            addLog(`ğŸ² ATK [${roll}] ${getSuccessLabel(successLevel)}`, 'roll');
            setCombatAction(prev => ({ ...prev, attackerRoll: roll, attackerSuccessLevel: successLevel }));
            setPhase('input_defense_roll');
        }
        setInputValue('');
    };

    const handleDefenseRoll = () => {
        const roll = parseInt(inputValue);
        if (!roll || roll < 1 || roll > 100) return;
        
        const result = executeOpposedCheck(combatAction.attackerSkill, combatAction.defenderSkill, combatAction.attackerRoll, roll, combatAction.defenseType);
        addLog(`ğŸ² DEF [${roll}] ${getSuccessLabel(result.defLvl)}`, 'roll');
        updateChar(targetActor.id, { status: { ...targetActor.status, defenseUsedThisRound: true } });
        
        if (result.winner === 'attacker') {
            if (combatAction.type === 'maneuver') {
                addLog(`âœ… ${combatAction.maneuverType} SUCCESS`, 'success');
                if (combatAction.maneuverType === 'knockdown') {
                    updateChar(targetActor.id, { status: { ...targetActor.status, prone: true } });
                }
                nextTurn();
            } else {
                setCombatAction(prev => ({ ...prev, damageAttacker: currentActor, damageSuccessLevel: result.atkLvl, isCounterAttack: false }));
                setPhase('input_damage');
            }
        } else {
            if (combatAction.defenseType === 'counter' && result.defLvl > 0) {
                addLog(`âš”ï¸ ${targetActor.name} COUNTER!`, 'success');
                setCombatAction(prev => ({ ...prev, damageAttacker: targetActor, damageSuccessLevel: result.defLvl, isCounterAttack: true, weapon: targetActor.meleeWeapon || { name: "æ‹³å¤´", damage: "1D3", impale: false } }));
                setPhase('input_damage');
            } else {
                addLog(`ğŸ’¨ MISS`, 'system');
                nextTurn();
            }
        }
        setInputValue('');
    };

    const handleDamage = () => {
        const damage = parseInt(inputValue) || 0;
        const target = combatAction.isCounterAttack ? currentActor : targetActor;
        const actualDamage = Math.max(0, damage - (target.armorValue || 0));
        const newHp = Math.max(0, target.hp - actualDamage);
        const isMajorWound = actualDamage >= Math.floor(target.maxHp / 2);
        let newStatus = { ...target.status };
        
        if (isMajorWound) {
            newStatus.majorWound = true;
            newStatus.prone = true;
            addLog(`ğŸ’€ ${target.name} MAJOR WOUND!`, 'damage');
        }
        if (newHp === 0 && newStatus.majorWound) {
            newStatus.dying = true;
            addLog(`âš ï¸ ${target.name} DYING!`, 'damage');
        }
        if (actualDamage >= target.maxHp) {
            addLog(`â˜ ï¸ ${target.name} DEAD!`, 'damage');
        }
        
        updateChar(target.id, { hp: newHp, status: newStatus });
        addLog(`ğŸ’¥ ${target.name} -${actualDamage} HP (${target.hp}â†’${newHp})`, 'damage');
        nextTurn();
    };

    return (
        <div className="combat-grid h-full">
            {/* å·¦ä¾§è§’è‰²åˆ—è¡¨ */}
            <div className={`panel-left panel-scroll ${mobileTab === 'status' ? 'panel-mobile-active' : ''}`}>
                <div className="p-2 border-b-2 border-black text-[10px] font-bold uppercase tracking-wide bg-white">TURN ORDER</div>
                <div className="p-2 space-y-1">
                    {combatOrder.map((c, i) => {
                        const isActive = i === turn.index % combatOrder.length;
                        const isTarget = selectedTargetId === c.id;
                        return (
                            <div 
                                key={c.id}
                                onClick={() => setSelectedTargetId(c.id)}
                                className={`char-card p-2 ${c.type === 'player' ? 'faction-strip-player' : 'faction-strip-enemy'} ${isActive ? 'selected' : ''} ${isTarget ? 'target-selected' : ''}`}
                            >
                                <div className="flex justify-between items-center">
                                    <div>
                                        <div className="font-bold text-xs">{c.name}</div>
                                        <div className="text-[10px] opacity-70 font-mono">DEX {c.hasGunReady ? c.dex + 50 : c.dex}</div>
                                    </div>
                                    <div className="text-right">
                                        <div className="font-mono font-bold text-sm">{c.hp}/{c.maxHp}</div>
                                        <div className="flex gap-0.5 mt-1 justify-end">
                                            {c.status.majorWound && <span className="text-[8px] bg-red-600 text-white px-1">ä¼¤</span>}
                                            {c.status.dying && <span className="text-[8px] bg-black text-white px-1">æ¿’</span>}
                                            {c.status.unconscious && <span className="text-[8px] bg-gray-600 text-white px-1">æ˜</span>}
                                            {c.status.prone && <span className="text-[8px] bg-gray-400 text-white px-1">å€’</span>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })}
                </div>
            </div>

            {/* ä¸­é—´æ“ä½œåŒº */}
            <div className={`panel-center ${mobileTab === 'action' ? 'panel-mobile-active' : ''}`}>
                <div className="p-3 border-b-2 border-black bg-white">
                    <div className="flex justify-between items-center">
                        <div>
                            <div className="label">CURRENT</div>
                            <div className="font-bold">{currentActor?.name || '-'}</div>
                        </div>
                        <div className="text-right">
                            <div className="label">TARGET</div>
                            <div className="font-bold">{targetActor?.name || 'â† SELECT'}</div>
                        </div>
                    </div>
                </div>

                <div className="action-area p-4">
                    <div className="centered-card p-4">
                        {/* é€‰æ‹©è¡ŒåŠ¨ */}
                        {phase === 'select_action' && !showMedical && (
                            <div className="space-y-3">
                                <div className="text-center font-bold text-sm uppercase border-b-2 border-black pb-2 mb-4">
                                    {currentActor?.name}'s TURN
                                </div>
                                
                                {!selectedTargetId ? (
                                    <div className="text-center text-gray-400 py-8 text-sm">â† SELECT TARGET</div>
                                ) : (
                                    <>
                                        {/* è¿‘æˆ˜ */}
                                        <div className="action-block">
                                            <div className="action-block-title">âš”ï¸ MELEE</div>
                                            <button onClick={handleMeleeAttack} className="action-btn">
                                                {currentActor?.meleeWeapon?.name || 'æ‹³å¤´'} ({currentActor?.meleeWeapon?.damage || '1D3'}+DB)
                                            </button>
                                        </div>

                                        {/* å°„å‡» */}
                                        <div className="action-block">
                                            <div className="action-block-title">ğŸ”« RANGED</div>
                                            {currentActor?.rangedWeapon ? (
                                                <>
                                                    <div className="flex gap-2 mb-2 items-center">
                                                        <span className="label">DIST:</span>
                                                        <SmartInput value={shootingDistance} onChange={setShootingDistance} />
                                                        <span className="text-xs font-mono">/ {currentActor.rangedWeapon.range}yd</span>
                                                    </div>
                                                    <button onClick={handleRangedAttack} disabled={currentActor.rangedWeapon.ammo <= 0} className="action-btn">
                                                        {currentActor.rangedWeapon.name} ({currentActor.rangedWeapon.damage}) [{currentActor.rangedWeapon.ammo}]
                                                    </button>
                                                </>
                                            ) : (
                                                <div className="text-center text-gray-400 py-2 text-sm">NO RANGED WEAPON</div>
                                            )}
                                        </div>

                                        {/* æˆ˜æŠ€ */}
                                        <div className="action-block">
                                            <div className="action-block-title">ğŸ¤¼ MANEUVER</div>
                                            <div className="grid grid-cols-4 gap-1 mb-2">
                                                {['disarm','knockdown','grapple','push'].map(m => (
                                                    <button key={m} onClick={() => setManeuverType(m)} className={`p-2 text-[10px] font-bold uppercase border-2 ${maneuverType === m ? 'bg-black text-white border-black' : 'border-black'}`}>
                                                        {m === 'disarm' ? 'ç¼´æ¢°' : m === 'knockdown' ? 'å‡»å€’' : m === 'grapple' ? 'å‹åˆ¶' : 'æ¨æ’'}
                                                    </button>
                                                ))}
                                            </div>
                                            <button onClick={handleManeuver} className="action-btn secondary">EXECUTE</button>
                                        </div>

                                        {/* åŒ»ç–— */}
                                        <div className="action-block">
                                            <div className="action-block-title">ğŸ’Š MEDICAL</div>
                                            <button onClick={() => setShowMedical(true)} className="action-btn secondary">FIRST AID / MEDICINE</button>
                                        </div>
                                    </>
                                )}
                                
                                <button onClick={nextTurn} className="w-full py-2 text-xs border-2 border-dashed border-black font-bold uppercase">SKIP TURN</button>
                            </div>
                        )}

                        {/* åŒ»ç–—é¢æ¿ */}
                        {phase === 'select_action' && showMedical && (
                            <div className="space-y-3">
                                <div className="text-center font-bold text-sm uppercase border-b-2 border-black pb-2 mb-4">
                                    ğŸ’Š MEDICAL ACTION
                                </div>
                                
                                <div className="p-3 border-2 border-black bg-gray-50">
                                    <div className="label mb-1">HEALER</div>
                                    <div className="font-bold">{currentActor?.name}</div>
                                    <div className="text-xs font-mono">æ€¥æ•‘ {currentActor?.firstAid || 30}% | åŒ»å­¦ {currentActor?.medicine || 5}%</div>
                                </div>

                                <div className="p-3 border-2 border-black">
                                    <div className="label mb-1">PATIENT</div>
                                    <div className="font-bold">{targetActor?.name || 'â† SELECT TARGET'}</div>
                                    {targetActor && (
                                        <div className="text-xs font-mono">
                                            HP: {targetActor.hp}/{targetActor.maxHp}
                                            {targetActor.status.dying && ' [DYING]'}
                                            {targetActor.status.unconscious && ' [UNCONSCIOUS]'}
                                        </div>
                                    )}
                                </div>

                                <div className="label mb-1">DICE MODIFIER</div>
                                <DiceModifierSelector value={diceModifier} onChange={setDiceModifier} />

                                <div className="grid grid-cols-2 gap-2">
                                    <button onClick={performFirstAid} disabled={!targetActor} className="action-btn">ğŸ©¹ æ€¥æ•‘ (+1HP)</button>
                                    <button onClick={performMedicine} disabled={!targetActor} className="action-btn">âš•ï¸ åŒ»å­¦ (+1D3)</button>
                                </div>

                                <button onClick={() => setShowMedical(false)} className="w-full py-2 text-xs border-2 border-black font-bold uppercase">â† BACK</button>
                            </div>
                        )}

                        {/* ç­‰å¾…é˜²å¾¡ */}
                        {phase === 'waiting_defense' && (
                            <div className="space-y-4">
                                <div className="flex justify-between items-center p-3 border-2 border-black">
                                    <div className="text-center">
                                        <div className="font-bold">{combatAction?.attacker.name}</div>
                                        <div className="text-[10px] bg-black text-white px-2 inline-block uppercase">ATK</div>
                                    </div>
                                    <div className="font-black text-2xl">VS</div>
                                    <div className="text-center">
                                        <div className="font-bold">{combatAction?.target.name}</div>
                                        <div className="text-[10px] bg-gray-500 text-white px-2 inline-block uppercase">DEF</div>
                                    </div>
                                </div>
                                
                                {targetActor?.status.defenseUsedThisRound && (
                                    <div className="text-xs text-center p-2 border-2 border-black bg-yellow-50 font-bold">
                                        âš ï¸ ALREADY DEFENDED (BONUS DICE FOR ATK)
                                    </div>
                                )}
                                
                                <div className="grid grid-cols-2 gap-3">
                                    <button 
                                        onClick={() => {
                                            setCombatAction(p => ({ ...p, defenseType: 'counter', defenderSkill: targetActor.fight }));
                                            setPhase('input_roll');
                                        }} 
                                        className="action-btn"
                                    >
                                        âš”ï¸ COUNTER<br/><span className="text-xs font-mono">{targetActor?.fight}%</span>
                                    </button>
                                    <button 
                                        onClick={() => {
                                            setCombatAction(p => ({ ...p, defenseType: 'dodge', defenderSkill: targetActor.dodge }));
                                            setPhase('input_roll');
                                        }} 
                                        className="action-btn secondary"
                                    >
                                        ğŸ’¨ DODGE<br/><span className="text-xs font-mono">{targetActor?.dodge}%</span>
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* è¾“å…¥æ£€å®š */}
                        {(['input_roll', 'input_defense_roll', 'input_damage'].includes(phase)) && combatAction && (
                            <div className="space-y-4">
                                <div className="text-center font-bold text-sm uppercase border-b-2 border-black pb-2">
                                    {phase === 'input_damage' ? 'DAMAGE' : phase === 'input_roll' ? `${currentActor.name} ROLL` : `${targetActor.name} DEFENSE`}
                                </div>
                                
                                {phase !== 'input_damage' && (
                                    <>
                                        <div className="text-center">
                                            <div className="label">TARGET NUMBER</div>
                                            <div className="text-4xl font-mono font-bold">
                                                {phase === 'input_roll' 
                                                    ? (combatAction.type === 'ranged' ? currentActor.firearms : combatAction.attackerSkill) 
                                                    : combatAction.defenderSkill}
                                            </div>
                                        </div>
                                        <DiceModifierSelector value={diceModifier} onChange={setDiceModifier} />
                                    </>
                                )}
                                
                                {phase === 'input_damage' && (
                                    <div className="text-center font-mono text-sm p-2 border-2 border-black">
                                        {combatAction.weapon?.name} ({combatAction.weapon?.damage})
                                    </div>
                                )}
                                
                                <div className="flex gap-2">
                                    <SmartInput 
                                        value={inputValue} 
                                        onChange={setInputValue}
                                        label={phase === 'input_damage' ? "DAMAGE" : "ROLL (1-100)"}
                                    />
                                    <button 
                                        onClick={() => {
                                            if (phase === 'input_damage') {
                                                const dmg = calculateDamage(combatAction.weapon, combatAction.damageAttacker, combatAction.damageSuccessLevel || 1, !!combatAction.isCounterAttack);
                                                setInputValue(String(dmg.total));
                                            } else {
                                                // ä½¿ç”¨åˆ†æ­¥éª¤éª°å­åŠ¨ç”»
                                                const targetNum = phase === 'input_roll' 
                                                    ? (combatAction.type === 'ranged' ? currentActor.firearms : combatAction.attackerSkill) 
                                                    : combatAction.defenderSkill;
                                                openStepDiceRoller(targetNum, null);
                                            }
                                        }} 
                                        className="px-4 border-2 border-black font-bold text-xl self-end h-[52px]"
                                    >
                                        ğŸ²
                                    </button>
                                </div>
                                
                                <button 
                                    onClick={phase === 'input_damage' ? handleDamage : phase === 'input_defense_roll' ? handleDefenseRoll : handleRoll} 
                                    disabled={!inputValue} 
                                    className="action-btn"
                                >
                                    CONFIRM
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            </div>

            {/* å³ä¾§æ—¥å¿— */}
            <div className={`panel-right ${mobileTab === 'log' ? 'panel-mobile-active' : ''}`}>
                <div className="p-2 border-b-2 border-black text-[10px] font-bold uppercase tracking-wide bg-white">COMBAT LOG</div>
                <div className="log-scroll-area" ref={logContainerRef}>
                    {logs.map(log => (
                        <div key={log.id}>
                            <div className="text-[9px] text-gray-400 mb-1 font-mono">{log.time}</div>
                            <div className={`log-item ${log.type}`}>{log.text}</div>
                        </div>
                    ))}
                </div>
            </div>

            {/* ç§»åŠ¨ç«¯å¯¼èˆª */}
            <div className="mobile-nav">
                {['status','action','log'].map(tab => (
                    <button key={tab} onClick={() => setMobileTab(tab)} className={`flex flex-col items-center justify-center w-full h-full ${mobileTab === tab ? 'bg-black text-white' : ''}`}>
                        <span className="text-lg">{tab === 'status' ? 'ğŸ“Š' : tab === 'action' ? 'âš”ï¸' : 'ğŸ“œ'}</span>
                        <span className="text-[10px] font-bold uppercase">{tab}</span>
                    </button>
                ))}
            </div>
            
            {/* åˆ†æ­¥éª¤éª°å­åŠ¨ç”» */}
            <StepDiceRoller 
                isOpen={showStepDice}
                modifier={diceModifier}
                targetNumber={stepDiceTargetNumber}
                onComplete={handleStepDiceComplete}
                onClose={() => setShowStepDice(false)}
            />
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
